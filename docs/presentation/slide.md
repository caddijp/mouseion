class: center, middle
name: title

# Brief Introduction to Mouseion

---

# Agenda

1. What it is
2. Motivation and Philosophy
3. Architecture
4. Publishing Documents
5. Tools

---

# What it is

[Mouseion](http://go/mouseion) is an internal document sharing system for FLYWHEEL. It may also mean the collection of shared documents themself in some context.

By using the Mouseion, we can easily and securely share any kind of files with users in the `@flywheel.jp` domain.

.footnote[The **Mouseion at Alexandria** was the home of music or poetry, a philosophical school and library such as Plato's Academy, also a storehouse of texts. This original word was the source for the modern usage of the word museum.]

---

# Movitation and Philosophy

* Maintain our documents.
    * FLYWHEEL uses Google Document to write a lot of documents, but unfortunately many are left unmaintained.
    * Documents that are strongly related to the source code should be stored in the corresponding git repository and updated as the source code changes.
* Use the Web standard technology.
    * FLYWHEEL uses a variety of programming languages and tools, so I didn't want to create a system that was easy to use for a particular project.
* Publish from CI.
    * Don't upload documents from your terminal.

---
# Publishing Documents

1. Create a [service account](https://console.cloud.google.com/iam-admin/serviceaccounts?project=flywheel-mouseion) with the "Storage Object Admin" role.
3. Authenticate gcloud SDK.
4. Upload files to flywheel-mouseion GCS bucket as the service account.

```bash
gsutil -m rsync -d -r path/to/dir gs://flywheel-mouseion/NAMESPACE
```

---
## GitHub Actions

Register Base64 encoded service account key exported as JSON as `GCLOUD_AUTH`:

```bash
base64 ~/Downloads/<account_id>.json | pbcopy
```

Then add `.github/workflos/publish.yml`:

```yaml
on:
  push:
    branches:
      - master
jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: GCP Authenticate
        uses: actions/gcloud/auth@master
        env:
          GCLOUD_AUTH: ${{ secrets.GCLOUD_AUTH }}
      - name: Publish documents to flywheel-mouseion bucket
        uses: docker://gcr.io/cloud-builders/gsutil
        with:
          args: -m rsync -d -r path/to/dir gs://flywheel-mouseion/NAMESPACE
```

---
## CircleCI

Register a raw service account key exported as JSON as `GCLOUD_AUTH` then:

```yaml
version: 2.1
jobs:
  publish:
    docker:
      - image: google/cloud-sdk
    steps:
      - checkout
      - run: echo $GCLOUD_AUTH | gcloud auth activate-service-account --key-file=-
      - run: gsutil -m rsync -d -r path/to/dir gs://flywheel-mouseion/NAMESPACE
```

---

# Architecture

<div class="mermaid">
graph LR
    Browser --> IAP
    subgraph GCP: flywheel-mouseion
        IAP[Cloud IAP] --> GAE
        GAE --> GCS[GCS<br/>gs://flywheel-mouseion]
    end
</div>

Mouseion consists of three components running in the `flywheel-mouseion` GCP project:

1. [Cloud Identity-Aware Proxy (Cloud IAP)](https://console.cloud.google.com/security/iap?project=flywheel-mouseion) controls access to our GAE application. Only users belonging to `flywheel.jp` domain are allowed to access the application.
2. [Google App Engine (GAE)](https://console.cloud.google.com/appengine?project=flywheel-mouseion) proxies GCS. [flywheel-jp/mouseion](https://github.com/flywheel-jp/mouseion) repository mainly contains its source code.
3. [Google Cloud Storage (GCS)](https://console.cloud.google.com/storage/browser/flywheel-mouseion/?project=flywheel-mouseion) stores documents.

---
class: center, middle

# Tools

---
## docsify

[docsify](https://docsify.js.org/) generates documentation website on the fly. It does not generate static html files. Instead, it loads and parses Markdown files and displays them as a website.

To start using it, all we need to do is create an `index.html`:

```html
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="//unpkg.com/docsify/lib/themes/vue.css">
  </head>
  <body>
    <div id="app"/>
    <script>
      window.$docsify = {
        // configure...
      }
    </script>
    <script src="//unpkg.com/docsify/lib/docsify.min.js"></script>
  </body>
</html>
```

and create a `README.md` to the same directory.

---
## remark

This presentation is generated by [remark](https://remarkjs.com/).
